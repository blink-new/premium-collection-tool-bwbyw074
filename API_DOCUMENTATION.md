# Premium Collection Tool - API Documentation\n\n## Overview\n\nThe Premium Collection Tool provides a comprehensive REST API and WebSocket integration for cell captives to manage premium collections, debit orders, and policy data. This document outlines the available endpoints, authentication methods, and integration patterns.\n\n## Database Integration\n\n### PostgreSQL Setup\n\nThe system uses PostgreSQL as the primary database with the following key tables:\n\n- **cell_captives**: Cell captive organizations\n- **api_keys**: API authentication keys for each cell captive\n- **policies**: Insurance policies and client information\n- **collections**: Premium collection records\n- **debit_order_files**: Generated debit order files for Investec\n- **reconciliation_records**: Payment reconciliation data\n- **webhook_logs**: API usage and webhook activity logs\n- **audit_trail**: Complete audit trail of all system changes\n\n### Environment Configuration\n\n```bash\n# PostgreSQL Database Configuration\nDB_HOST=localhost\nDB_PORT=5432\nDB_NAME=premium_collection\nDB_USER=postgres\nDB_PASSWORD=password\n\n# Alternative: Database URL (overrides individual DB settings)\nDATABASE_URL=postgresql://username:password@localhost:5432/premium_collection\n```\n\n## Authentication\n\n### API Key Generation\n\nAPI keys are generated for each cell captive through the admin interface:\n\n1. Navigate to **API Keys** page in the admin dashboard\n2. Click **Generate API Key**\n3. Select the cell captive and configure permissions\n4. Copy the generated API key (shown only once)\n\n### API Key Format\n\nAll API keys follow the format: `pct_[64-character-hex-string]`\n\nExample: `pct_a1b2c3d4e5f6789012345678901234567890abcdef1234567890abcdef123456`\n\n### Authentication Header\n\n```http\nAuthorization: Bearer pct_your_api_key_here\n```\n\n### Permissions\n\nAPI keys can be configured with specific permissions:\n\n- `collections:read` - View collection data\n- `collections:write` - Create and update collections\n- `policies:read` - View policy data\n- `policies:write` - Create and update policies\n- `webhooks:receive` - Receive webhook notifications\n- `*` - Full access to all endpoints\n\n## API Endpoints\n\n### Base URL\n\n```\nhttp://localhost:5000/api\n```\n\n### Webhook Endpoints\n\n#### 1. Update Collection Status\n\n**Endpoint:** `POST /webhooks/collections/update`\n\n**Description:** Update the status of a specific collection\n\n**Required Permission:** `collections:write`\n\n**Request Body:**\n```json\n{\n  \"collection_reference\": \"COL_123456\",\n  \"status\": \"successful\",\n  \"amount\": 1500.00,\n  \"failure_reason\": null,\n  \"investec_reference\": \"INV_789012\",\n  \"bank_reference\": \"BANK_345678\",\n  \"transaction_date\": \"2024-01-15\"\n}\n```\n\n**Alternative (by Policy Number):**\n```json\n{\n  \"policy_number\": \"POL_123456\",\n  \"status\": \"failed\",\n  \"failure_reason\": \"Insufficient funds\",\n  \"collection_date\": \"2024-01-15\"\n}\n```\n\n**Valid Status Values:**\n- `pending` - Collection is pending processing\n- `submitted` - Collection has been submitted to bank\n- `successful` - Collection completed successfully\n- `failed` - Collection failed\n- `cancelled` - Collection was cancelled\n\n**Response:**\n```json\n{\n  \"data\": {\n    \"collection\": {\n      \"id\": \"uuid\",\n      \"collection_reference\": \"COL_123456\",\n      \"policy_number\": \"POL_123456\",\n      \"client_name\": \"John Doe\",\n      \"amount\": 1500.00,\n      \"status\": \"successful\",\n      \"collection_date\": \"2024-01-15\",\n      \"processed_at\": \"2024-01-15T10:30:00Z\",\n      \"investec_reference\": \"INV_789012\"\n    },\n    \"message\": \"Collection updated successfully\"\n  }\n}\n```\n\n#### 2. Bulk Update Collections\n\n**Endpoint:** `POST /webhooks/collections/bulk-update`\n\n**Description:** Update multiple collections in a single request (max 100)\n\n**Required Permission:** `collections:write`\n\n**Request Body:**\n```json\n{\n  \"collections\": [\n    {\n      \"collection_reference\": \"COL_123456\",\n      \"status\": \"successful\",\n      \"investec_reference\": \"INV_789012\"\n    },\n    {\n      \"policy_number\": \"POL_789012\",\n      \"status\": \"failed\",\n      \"failure_reason\": \"Account closed\"\n    }\n  ]\n}\n```\n\n**Response:**\n```json\n{\n  \"data\": {\n    \"processed\": 2,\n    \"errors\": 0,\n    \"results\": [\n      {\n        \"index\": 0,\n        \"collection\": { /* collection object */ },\n        \"status\": \"updated\"\n      }\n    ],\n    \"errors\": []\n  },\n  \"message\": \"Processed 2 collections, 0 errors\"\n}\n```\n\n#### 3. Update Policy Information\n\n**Endpoint:** `POST /webhooks/policies/update`\n\n**Description:** Create or update policy information\n\n**Required Permission:** `policies:write`\n\n**Request Body:**\n```json\n{\n  \"policy_number\": \"POL_123456\",\n  \"client_name\": \"John Doe\",\n  \"client_email\": \"john.doe@example.com\",\n  \"client_phone\": \"+27123456789\",\n  \"premium_amount\": 1500.00,\n  \"frequency\": \"monthly\",\n  \"status\": \"active\",\n  \"mandate_reference\": \"MAN_789012\",\n  \"bank_account_number\": \"1234567890\",\n  \"bank_branch_code\": \"123456\",\n  \"next_collection_date\": \"2024-02-01\"\n}\n```\n\n**Valid Frequency Values:**\n- `monthly`\n- `quarterly`\n- `annually`\n\n**Valid Status Values:**\n- `active`\n- `lapsed`\n- `cancelled`\n\n#### 4. View Webhook Logs\n\n**Endpoint:** `GET /webhooks/logs`\n\n**Description:** View webhook activity logs for your cell captive\n\n**Query Parameters:**\n- `page` (optional): Page number (default: 1)\n- `limit` (optional): Items per page (default: 50, max: 100)\n- `status_code` (optional): Filter by HTTP status code\n\n**Response:**\n```json\n{\n  \"data\": [\n    {\n      \"id\": \"uuid\",\n      \"endpoint\": \"/api/webhooks/collections/update\",\n      \"method\": \"POST\",\n      \"response_status\": 200,\n      \"processing_time_ms\": 45,\n      \"created_at\": \"2024-01-15T10:30:00Z\"\n    }\n  ],\n  \"pagination\": {\n    \"page\": 1,\n    \"limit\": 50,\n    \"total\": 150,\n    \"pages\": 3\n  }\n}\n```\n\n### Error Responses\n\nAll endpoints return consistent error responses:\n\n```json\n{\n  \"error\": {\n    \"message\": \"Error description\",\n    \"code\": \"ERROR_CODE\"\n  }\n}\n```\n\n**Common Error Codes:**\n- `MISSING_API_KEY` - Authorization header missing\n- `INVALID_API_KEY` - API key not found or invalid format\n- `API_KEY_REVOKED` - API key has been revoked\n- `API_KEY_EXPIRED` - API key has expired\n- `CAPTIVE_INACTIVE` - Cell captive account is inactive\n- `INSUFFICIENT_PERMISSIONS` - API key lacks required permission\n- `COLLECTION_NOT_FOUND` - Collection reference not found\n- `POLICY_NOT_FOUND` - Policy number not found\n- `INVALID_STATUS` - Invalid status value provided\n\n## WebSocket Integration\n\n### Connection\n\n**Endpoint:** `ws://localhost:5000/ws`\n\n**Authentication:** Send authentication message after connection:\n\n```json\n{\n  \"type\": \"auth\",\n  \"token\": \"your_jwt_token_here\"\n}\n```\n\n### Real-time Events\n\nThe system broadcasts the following events via WebSocket:\n\n#### Collection Updated\n```json\n{\n  \"type\": \"collection_updated\",\n  \"data\": {\n    \"collection\": { /* collection object */ },\n    \"cell_captive\": { /* cell captive info */ },\n    \"updated_by\": \"webhook\"\n  },\n  \"timestamp\": \"2024-01-15T10:30:00Z\"\n}\n```\n\n#### Policy Updated\n```json\n{\n  \"type\": \"policy_updated\",\n  \"data\": {\n    \"policy\": { /* policy object */ },\n    \"cell_captive\": { /* cell captive info */ },\n    \"updated_by\": \"webhook\"\n  },\n  \"timestamp\": \"2024-01-15T10:30:00Z\"\n}\n```\n\n## Integration Examples\n\n### cURL Examples\n\n#### Update Collection Status\n```bash\ncurl -X POST http://localhost:5000/api/webhooks/collections/update \\\n  -H \"Authorization: Bearer pct_your_api_key_here\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"collection_reference\": \"COL_123456\",\n    \"status\": \"successful\",\n    \"investec_reference\": \"INV_789012\",\n    \"bank_reference\": \"BANK_345678\"\n  }'\n```\n\n#### Create/Update Policy\n```bash\ncurl -X POST http://localhost:5000/api/webhooks/policies/update \\\n  -H \"Authorization: Bearer pct_your_api_key_here\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"policy_number\": \"POL_123456\",\n    \"client_name\": \"John Doe\",\n    \"client_email\": \"john.doe@example.com\",\n    \"premium_amount\": 1500.00,\n    \"frequency\": \"monthly\",\n    \"status\": \"active\"\n  }'\n```\n\n### Python Example\n\n```python\nimport requests\nimport json\n\nclass PremiumCollectionAPI:\n    def __init__(self, api_key, base_url=\"http://localhost:5000/api\"):\n        self.api_key = api_key\n        self.base_url = base_url\n        self.headers = {\n            \"Authorization\": f\"Bearer {api_key}\",\n            \"Content-Type\": \"application/json\"\n        }\n    \n    def update_collection(self, collection_reference, status, **kwargs):\n        \"\"\"Update collection status\"\"\"\n        data = {\n            \"collection_reference\": collection_reference,\n            \"status\": status,\n            **kwargs\n        }\n        \n        response = requests.post(\n            f\"{self.base_url}/webhooks/collections/update\",\n            headers=self.headers,\n            json=data\n        )\n        \n        return response.json()\n    \n    def update_policy(self, policy_number, **policy_data):\n        \"\"\"Create or update policy\"\"\"\n        data = {\n            \"policy_number\": policy_number,\n            **policy_data\n        }\n        \n        response = requests.post(\n            f\"{self.base_url}/webhooks/policies/update\",\n            headers=self.headers,\n            json=data\n        )\n        \n        return response.json()\n    \n    def get_webhook_logs(self, page=1, limit=50):\n        \"\"\"Get webhook logs\"\"\"\n        params = {\"page\": page, \"limit\": limit}\n        \n        response = requests.get(\n            f\"{self.base_url}/webhooks/logs\",\n            headers=self.headers,\n            params=params\n        )\n        \n        return response.json()\n\n# Usage\napi = PremiumCollectionAPI(\"pct_your_api_key_here\")\n\n# Update collection status\nresult = api.update_collection(\n    collection_reference=\"COL_123456\",\n    status=\"successful\",\n    investec_reference=\"INV_789012\"\n)\n\n# Create/update policy\nresult = api.update_policy(\n    policy_number=\"POL_123456\",\n    client_name=\"John Doe\",\n    client_email=\"john.doe@example.com\",\n    premium_amount=1500.00,\n    frequency=\"monthly\",\n    status=\"active\"\n)\n```\n\n### Node.js Example\n\n```javascript\nconst axios = require('axios');\n\nclass PremiumCollectionAPI {\n  constructor(apiKey, baseUrl = 'http://localhost:5000/api') {\n    this.apiKey = apiKey;\n    this.baseUrl = baseUrl;\n    this.headers = {\n      'Authorization': `Bearer ${apiKey}`,\n      'Content-Type': 'application/json'\n    };\n  }\n\n  async updateCollection(collectionReference, status, additionalData = {}) {\n    const data = {\n      collection_reference: collectionReference,\n      status,\n      ...additionalData\n    };\n\n    try {\n      const response = await axios.post(\n        `${this.baseUrl}/webhooks/collections/update`,\n        data,\n        { headers: this.headers }\n      );\n      return response.data;\n    } catch (error) {\n      throw new Error(`API Error: ${error.response?.data?.error?.message || error.message}`);\n    }\n  }\n\n  async updatePolicy(policyNumber, policyData) {\n    const data = {\n      policy_number: policyNumber,\n      ...policyData\n    };\n\n    try {\n      const response = await axios.post(\n        `${this.baseUrl}/webhooks/policies/update`,\n        data,\n        { headers: this.headers }\n      );\n      return response.data;\n    } catch (error) {\n      throw new Error(`API Error: ${error.response?.data?.error?.message || error.message}`);\n    }\n  }\n\n  async getWebhookLogs(page = 1, limit = 50) {\n    try {\n      const response = await axios.get(\n        `${this.baseUrl}/webhooks/logs`,\n        {\n          headers: this.headers,\n          params: { page, limit }\n        }\n      );\n      return response.data;\n    } catch (error) {\n      throw new Error(`API Error: ${error.response?.data?.error?.message || error.message}`);\n    }\n  }\n}\n\n// Usage\nconst api = new PremiumCollectionAPI('pct_your_api_key_here');\n\n// Update collection status\napi.updateCollection('COL_123456', 'successful', {\n  investec_reference: 'INV_789012',\n  bank_reference: 'BANK_345678'\n})\n.then(result => console.log('Collection updated:', result))\n.catch(error => console.error('Error:', error.message));\n```\n\n## Rate Limiting\n\n- **Standard endpoints**: 1000 requests per hour per API key\n- **Bulk endpoints**: 100 requests per hour per API key\n- **WebSocket connections**: 10 concurrent connections per cell captive\n\n## Security Considerations\n\n1. **API Key Storage**: Store API keys securely and never expose them in client-side code\n2. **HTTPS**: Always use HTTPS in production environments\n3. **IP Whitelisting**: Consider implementing IP whitelisting for additional security\n4. **Key Rotation**: Regularly rotate API keys and set appropriate expiration dates\n5. **Monitoring**: Monitor webhook logs for unusual activity\n\n## Support\n\nFor technical support or questions about the API:\n\n- **Email**: support@premiumcollection.com\n- **Documentation**: Check the admin dashboard for real-time API status\n- **Logs**: Use the webhook logs endpoint to debug integration issues\n\n## Changelog\n\n### Version 1.0.0 (Current)\n- Initial API release\n- Collection status updates\n- Policy management\n- Bulk operations\n- WebSocket real-time updates\n- Comprehensive audit logging"